# foco-duo ‚Äî mini‚Äëcursos sob demanda (Pomodoro + SRS)
> **Hackathon MVP** ‚Äî ‚ÄúDuolingo para *qualquer assunto*‚Äù: digite um tema, gere um mini‚Äëcurso e estude com foco (Pomodoro) + revis√£o espa√ßada (SRS).

Este reposit√≥rio cont√©m **frontend (Next.js)** e **backend (Fastify + PostgreSQL)** de um prot√≥tipo funcional.  
A **Home** j√° aceita um tema (ex.: *Eletrost√°tica b√°sica*) e abre um **curso** com **li√ß√µes**. No MVP atual as li√ß√µes s√£o **placeholders**; abaixo explicamos **o que j√° fizemos** e **o que quer√≠amos fazer** (design da gera√ß√£o autom√°tica com LLM, fallback com dados abertos, Pomodoro e SRS integrados).

---

## üß≠ Sum√°rio
- [Vis√£o do Produto](#vis√£o-do-produto)
- [O que j√° fizemos (MVP)](#o-que-j√°-fizemos-mvp)
- [O que quer√≠amos fazer (Design detalhado)](#o-que-quer√≠amos-fazer-design-detalhado)
  - [Gera√ß√£o autom√°tica de cursos e quest√µes](#gera√ß√£o-autom√°tica-de-cursos-e-quest√µes)
  - [Fallback com banco aberto (Open Trivia DB)](#fallback-com-banco-aberto-open-trivia-db)
  - [SRS (revis√£o espa√ßada) proposto](#srs-revis√£o-espa√ßada-proposto)
  - [Pomodoro proposto](#pomodoro-proposto)
- [Arquitetura](#arquitetura)
- [Banco de Dados](#banco-de-dados)
- [API (endpoints)](#api-endpoints)
- [Como rodar localmente](#como-rodar-localmente)
- [Deploy (Nginx, systemd)](#deploy-nginx-systemd)
- [Troubleshooting r√°pido](#troubleshooting-r√°pido)
- [Roadmap](#roadmap)
- [Licen√ßas e atribui√ß√£o](#licen√ßas-e-atribui√ß√£o)

---

## Vis√£o do Produto
1. **Entrada simples**: o aluno digita *qualquer assunto* (‚Äúmatem√°tica financeira‚Äù, ‚ÄúAmp√®re‚Äù, ‚Äúhist√≥ria do Brasil s√©culo XIX‚Äù).  
2. **Mini‚Äëcurso**: sistema cria 3‚Äì5 li√ß√µes progressivas (Fundamentos ‚Üí Pr√°tica ‚Üí Desafios).  
3. **Quest√µes MCQ**: cada li√ß√£o vem com ~10 quest√µes (4 alternativas, 1 correta, explica√ß√£o), em **pt‚ÄëBR**.  
4. **Estudo com ritmo**: **Pomodoro** (25/5 por padr√£o) + **SRS** (reagendamento baseado em acertos/erros).  
5. **Acompanhamento**: progresso por li√ß√£o, acur√°cia, tempo em foco.

> üí° **Motiva√ß√£o**: permitir ao aluno transformar *qualquer curiosidade* em um plano breve e objetivo de estudo, com pr√°tica imediata.

---

## O que j√° fizemos (MVP)
- **Frontend (Next.js)**  
  - Landing page com campo *‚ÄúCrie um curso‚Äù* + UI escura, responsiva.  
  - P√°ginas para **Curso** e **Li√ß√µes** (slots ‚ÄúLi√ß√£o 1, 2, 3‚Ä¶‚Äù).  
- **Backend (Fastify + TypeScript)**  
  - Migra√ß√µes de **perguntas/alternativas** e **cursos/li√ß√µes**.  
  - Endpoints prontos (vide se√ß√£o API).  
  - Esqueleto de servi√ßo `courseGen.ts` prevendo uso de **LLM** para gerar plano + MCQs.  
- **Importadores**  
  - Esqueleto para ingest√£o de dados abertos (ex.: **Open Trivia DB**) como *seed* ou *fallback*.  
- **Infra b√°sica**  
  - Deploy de Next em produ√ß√£o via `npm run build && npm start -p 3001`.  
  - Reverse proxy Nginx com rota para est√°ticos `/_next/static/` e roteamento `/api`.

> ‚ö†Ô∏è **Status:** cria√ß√£o de curso j√° existe; **preenchimento autom√°tico das li√ß√µes** √© conectado quando `OPENAI_API_KEY` estiver definido (ou via fallback).

---

## O que quer√≠amos fazer (Design detalhado)

### Gera√ß√£o autom√°tica de cursos e quest√µes
Quando o aluno clicar **Criar curso**:
1. **Plano do curso** (3‚Äì5 li√ß√µes)  
   - `buildCoursePlan(topic)` pede ao LLM um JSON com `title`, `summary`, `objectives` por li√ß√£o.  
2. **Quest√µes por li√ß√£o**  
   - `generateLessonMCQs(topic, lessonTitle, count)` retorna um array de MCQs:  
     ```json
     {
       "stem": "enunciado",
       "choices": [
         {"text":"A","is_correct":false},
         {"text":"B","is_correct":true},
         {"text":"C","is_correct":false},
         {"text":"D","is_correct":false}
       ],
       "explanation":"por que a correta est√° certa",
       "difficulty":"easy|medium|hard"
     }
     ```
3. **Persist√™ncia**  
   - `POST /courses` orquestra: cria `course` e `lessons`, salva `questions`/`choices`, vincula em `lesson_questions` e devolve `{id, slug}`.  
4. **Render**  
   - Front abre `/curso/[slug]` e lista li√ß√µes **j√° preenchidas**; p√°gina de li√ß√£o mostra as MCQs.

> üîê **Vari√°veis**: `OPENAI_API_KEY` no `.env` do backend (`api/`).  
> üß™ **Modelos**: usar um LLM de custo baixo para MCQs e outro para revis√µes finas (se necess√°rio).

### Fallback com banco aberto (Open Trivia DB)
- Se `OPENAI_API_KEY` estiver ausente ou a gera√ß√£o falhar, o sistema pode:  
  **(a)** criar o *esqueleto* do curso (li√ß√µes vazias), **ou**  
  **(b)** importar um lote relacionado de um **banco aberto** (ex.: Open Trivia DB) e preencher a li√ß√£o.  
- Todos os itens ficam com `source='opentdb'` e **atribui√ß√£o** no rodap√©.

### SRS (revis√£o espa√ßada) proposto
- **Modelo simples (Leitner)** para o MVP:  
  - Acertou: cart√£o sobe de caixa (reaparece com maior intervalo).  
  - Errou: volta para a primeira caixa (revis√£o cedo).  
- **Evolu√ß√£o**: SM‚Äë2/SM‚Äë5 (Anki) com *ease factor*, *interval* e *repetition*.  
- **Persist√™ncia**: tabela `reviews` (proposta) com `user_id`, `question_id`, `grade`, `next_due_at`.

### Pomodoro proposto
- Ciclos **25/5** configur√°veis ‚Üí **25 min** foco, **5 min** pausa.  
- Contador local (frontend) com eventos enviados ao backend para m√©tricas.  
- Estat√≠sticas por dia (tempo em foco, sess√µes conclu√≠das, tarefas ligadas √† li√ß√£o).

---

## Arquitetura
```
.
‚îú‚îÄ web/                      # Next.js (UI)
‚îÇ  ‚îú‚îÄ app/                   # p√°ginas (Home, Curso, Li√ß√£o)
‚îÇ  ‚îî‚îÄ components/            # UI base
‚îú‚îÄ api/                      # Fastify + PostgreSQL
‚îÇ  ‚îú‚îÄ src/db/                # migra√ß√µes
‚îÇ  ‚îÇ  ‚îú‚îÄ migrate.ts          # questions/choices
‚îÇ  ‚îÇ  ‚îî‚îÄ migrate_courses.ts  # courses/lessons/lesson_questions
‚îÇ  ‚îú‚îÄ src/routes/            # endpoints
‚îÇ  ‚îÇ  ‚îú‚îÄ questions.ts
‚îÇ  ‚îÇ  ‚îî‚îÄ courses.ts
‚îÇ  ‚îî‚îÄ src/services/
‚îÇ     ‚îî‚îÄ courseGen.ts        # OpenAI (plano + MCQs)
‚îî‚îÄ docs/                     # screenshots p/ README
```

**Fluxo:** `web ‚Üí POST /courses ‚Üí (LLM ou fallback) ‚Üí persist√™ncia ‚Üí GET /courses/:slug ‚Üí render`.

---

## Banco de Dados
### Tabelas principais
```sql
-- perguntas/alternativas
questions(
  id BIGSERIAL PRIMARY KEY,
  source TEXT NOT NULL,              -- 'generated', 'opentdb', 'manual'...
  external_id TEXT,
  category TEXT,
  qtype TEXT CHECK (qtype IN ('multiple','boolean','open')) NOT NULL,
  difficulty TEXT CHECK (difficulty IN ('easy','medium','hard','unknown')) NOT NULL DEFAULT 'unknown',
  stem TEXT NOT NULL,
  explanation TEXT,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  UNIQUE(source, external_id)
);

choices(
  id BIGSERIAL PRIMARY KEY,
  question_id BIGINT NOT NULL REFERENCES questions(id) ON DELETE CASCADE,
  text TEXT NOT NULL,
  is_correct BOOLEAN NOT NULL DEFAULT false,
  position INTEGER
);

-- cursos/li√ß√µes
courses(
  id BIGSERIAL PRIMARY KEY,
  topic TEXT NOT NULL,
  slug TEXT NOT NULL UNIQUE,
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

lessons(
  id BIGSERIAL PRIMARY KEY,
  course_id BIGINT NOT NULL REFERENCES courses(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  summary TEXT,
  position INT NOT NULL,
  UNIQUE(course_id, position)
);

lesson_questions(
  lesson_id BIGINT NOT NULL REFERENCES lessons(id) ON DELETE CASCADE,
  question_id BIGINT NOT NULL REFERENCES questions(id) ON DELETE CASCADE,
  PRIMARY KEY (lesson_id, question_id)
);
```

> üß© **Ordem das migra√ß√µes importa**: rode **`migrate.ts`** antes de **`migrate_courses.ts`**.

---

## API (endpoints)

### Criar curso
```
POST /courses
Body:
{
  "topic": "Eletrost√°tica b√°sica",
  "questionsPerLesson": 10
}
‚Üí 201 { "id": 123, "slug": "eletrostatica-basica" }
```

### Ler curso + li√ß√µes
```
GET /courses/:slug
‚Üí { "course": {...}, "lessons": [ ... ] }
```

### Listar quest√µes de uma li√ß√£o
```
GET /lessons/:id/questions
‚Üí [ { "id": 1, "stem": "...", "choices": [...], "explanation": "...", "difficulty": "medium" }, ... ]
```

### Amostra rand√¥mica (debug)
```
GET /questions/random?count=5&difficulty=medium&category=F√≠sica
```

---

## Como rodar localmente
### Requisitos
- Node 18+ (recomendado 20+)  
- PostgreSQL 13+  
- npm

### 1) API
```bash
cd api
npm i

# .env (exemplo)
cat > .env << 'EOF'
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/studysprint
OPENAI_API_KEY=sk-xxxxx             # opcional para o MVP; necess√°rio p/ gera√ß√£o autom√°tica
PORT=3333
EOF

# migra√ß√µes
npx tsx src/db/migrate.ts
npx tsx src/db/migrate_courses.ts

npm run dev          # ou: npm run build && npm start
```

### 2) Web
```bash
cd web
npm i
echo "NEXT_PUBLIC_API_BASE=http://localhost:3333" > .env.local
npm run dev          # produ√ß√£o: npm run build && npm run start -p 3001
```

Acesse `http://localhost:3000`.

---

## Deploy (Nginx, systemd)
### Next.js como servi√ßo (exemplo)
`/etc/systemd/system/focoduo-web.service`
```ini
[Unit]
Description=Next.js foco-duo
After=network.target

[Service]
User=ubuntu
WorkingDirectory=/home/ubuntu/repo/web
Environment=PORT=3001
ExecStart=/usr/bin/npm run start -- -p 3001
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

### Fastify API como servi√ßo
`/etc/systemd/system/focoduo-api.service`
```ini
[Unit]
Description=API foco-duo
After=network.target

[Service]
User=ubuntu
WorkingDirectory=/home/ubuntu/repo/api
Environment=PORT=3333
Environment=NODE_ENV=production
ExecStart=/usr/bin/npm start
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

### Nginx (reverse proxy)
```nginx
server {
  listen 80;
  server_name SEU_DOMINIO_OU_IP;

  location / {
    proxy_pass http://127.0.0.1:3001;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }

  location /_next/static/ {
    proxy_pass http://127.0.0.1:3001;
    add_header Cache-Control "public, max-age=31536000, immutable";
  }

  location /api/ {
    proxy_pass http://127.0.0.1:3333;
  }
}
```

> üîí Para HTTPS, use `certbot --nginx -d seu.dominio.com` ap√≥s apontar DNS.

---

## Troubleshooting r√°pido
- **`42P01: relation "questions" does not exist`**  
  ‚Üí Rode `npx tsx src/db/migrate.ts` antes de `migrate_courses.ts`; confira `DATABASE_URL`.
- **`EADDRINUSE: :3001`**  
  ‚Üí Porta ocupada. Linux/macOS: `lsof -i :3001` ‚Üí mate o processo. Windows: `netstat -ano | findstr :3001`.
- **Site ‚Äúsem estilo‚Äù em prod**  
  ‚Üí Falta proxy de `/_next/static/` no Nginx **ou** `assetPrefix` apontando para `localhost`. Use o bloco acima.
- **`OPENAI_API_KEY` n√£o lida**  
  ‚Üí Confira `.env` no diret√≥rio **api/** e `import 'dotenv/config'` antes de ler `process.env`.  
  ‚Üí Teste: `npx tsx -e "import 'dotenv/config'; console.log(!!process.env.OPENAI_API_KEY)"` ‚Üí deve imprimir `true`.

---

## Roadmap
- [ ] Conectar bot√£o **Criar curso** do frontend ao `POST /courses`.
- [ ] Ativar gera√ß√£o autom√°tica via `OPENAI_API_KEY`.
- [ ] Fallback com **Open Trivia DB** (seed/tema gen√©rico).
- [ ] Implementar **SRS** (Leitner ‚Üí SM‚Äë2) com hist√≥rico por usu√°rio.
- [ ] Pomodoro integrado a tarefas/tempo por li√ß√£o.
- [ ] Painel de progresso (acertos, tempo, li√ß√µes conclu√≠das).
- [ ] Testes automatizados (vitest) e CI.
- [ ] Internacionaliza√ß√£o (pt‚ÄëBR/en).
- [ ] Acessibilidade (atalhos, ARIA, contraste).
- [ ] Observabilidade (logs estruturados, m√©tricas b√°sicas).

---

## Licen√ßas e atribui√ß√£o
- C√≥digo do projeto: escolha e defina uma licen√ßa (ex.: MIT).  
- Bancos abertos (se usados):
  - **Open Trivia DB** ‚Äî CC BY‚ÄëSA 4.0 (requer atribui√ß√£o/share‚Äëalike).  
  - Outros datasets acad√™micos (ARC, QASC etc.): verificar licen√ßa e incluir cr√©ditos.  
- Sugerimos exibir no rodap√©:  
  > ‚ÄúAlgumas quest√µes fornecidas por **Open Trivia DB (CC BY‚ÄëSA 4.0)**.‚Äù

---

**D√∫vidas, sugest√µes ou bugs?** Abra uma issue.  
**Equipe:** Design & Eng. ‚Äî foco em aprendizado eficiente com gera√ß√£o autom√°tica e pr√°tica estruturada.
